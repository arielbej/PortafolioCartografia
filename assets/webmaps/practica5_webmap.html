<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Práctica 5 - Severidad Raster</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Montserrat', sans-serif; }
        #map { height: 100vh; width: 100%; }
        .info-panel {
            position: absolute; top: 10px; left: 10px;
            background: white; padding: 15px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 1000;
        }
        .legend {
            position: absolute; bottom: 30px; right: 10px;
            background: white; padding: 15px; border-radius: 5px;
            z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .legend-item { display: flex; align-items: center; margin: 5px 0; }
        .legend-color { width: 30px; height: 20px; margin-right: 10px; border: 1px solid #333; }
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 20px; border-radius: 8px; z-index: 2000;
        }
    </style>
</head>
<body>

    <div id="loading">Cargando Raster Severidad...</div>
    <div id="map"></div>
    
    <div class="info-panel">
        <h3>Zonas Válidas (Raster)</h3>
        <p><strong>Archivo:</strong> Severidad.tif</p>
        <p><strong>Región:</strong> Castilla y León</p>
    </div>

    <div class="legend">
        <h4>Categorías</h4>
        <div class="legend-item"><div class="legend-color" style="background: #2ca25f;"></div><span>Alto (3)</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #ffdd33;"></div><span>Medio (4)</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #de2d26;"></div><span>Bajo (5)</span></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://unpkg.com/georaster"></script>
    <script src="https://unpkg.com/georaster-layer-for-leaflet/dist/georaster-layer-for-leaflet.min.js"></script>
    <script src="https://unpkg.com/geoblaze"></script>

    <script>
        // Inicializar mapa
        const map = L.map('map').setView([41.5, -4], 7);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CartoDB'
        }).addTo(map);

        // NOMBRE CORREGIDO según tu captura de VS Code
        const tiffUrl = "Severidad.tif"; 

        fetch(tiffUrl)
            .then(response => {
                if (!response.ok) throw new Error("No se encuentra el archivo Severidad.tif en esta carpeta");
                return response.arrayBuffer();
            })
            .then(arrayBuffer => {
                parseGeoraster(arrayBuffer).then(georaster => {
                    
                    const layer = new GeoRasterLayer({
                        georaster: georaster,
                        opacity: 0.8,
                        pixelValuesToColorFn: function(pixelValues) {
                            const val = pixelValues[0];
                            // Usamos comparaciones redondeadas por si el raster tiene decimales
                            if (val >= 2.5 && val < 3.5) return '#2ca25f'; // Clase 3
                            if (val >= 3.5 && val < 4.5) return '#ffdd33'; // Clase 4
                            if (val >= 4.5 && val < 5.5) return '#de2d26'; // Clase 5
                            return null;
                        },
                        resolution: 128
                    });

                    layer.addTo(map);
                    map.fitBounds(layer.getBounds());
                    document.getElementById('loading').style.display = 'none';
                });
            })
            .catch(err => {
                console.error(err);
                document.getElementById('loading').innerHTML = `<strong>Error:</strong> ${err.message}<br><small>Asegúrate de usar Live Server</small>`;
            });
    </script>
</body>
</html>