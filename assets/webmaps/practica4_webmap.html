<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pr√°ctica 4 - Zonas V√°lidas</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Montserrat', sans-serif; }
        #map { height: 100vh; width: 100%; }
        
        .info-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 300px;
        }
        
        .info-panel h3 {
            margin: 0 0 10px 0;
            color: #2ca25f;
        }
        
        #fullscreen-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .basemap-selector {
            position: absolute;
            bottom: 30px;
            left: 10px;
            z-index: 1000;
        }
        
        .basemap-toggle {
            background: white;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 14px;
        }
        
        .basemap-menu {
            display: none;
            background: white;
            margin-top: 5px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            padding: 10px;
        }
        
        .basemap-option {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 3px;
            margin: 3px 0;
        }
        
        .basemap-option:hover {
            background: #f0f0f0;
        }
        
        .legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        
        .legend h4 {
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        
        .legend-color {
            width: 30px;
            height: 20px;
            margin-right: 10px;
            border: 1px solid #333;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 2000;
        }
    </style>
</head>
<body>
    <div id="loading">Cargando datos...</div>
    <div id="map"></div>
    
    <div class="info-panel">
        <h3>Zonas V√°lidas</h3>
        <p><strong>Descripci√≥n:</strong> Visualizaci√≥n de √°reas clasificadas por idoneidad</p>
        <p><strong>Regi√≥n:</strong> Castilla y Le√≥n</p>
    </div>
    
    <button id="fullscreen-btn">
        <i class="fas fa-expand"></i>
    </button>
    
    <div class="basemap-selector">
        <div class="basemap-toggle" onclick="toggleMenu()">
            <i class="fas fa-layer-group"></i> Cambiar Mapa Base
        </div>
        <div id="basemapMenu" class="basemap-menu">
            <div class="basemap-option" onclick="changeBaseMap('light')">üó∫Ô∏è Claro</div>
            <div class="basemap-option" onclick="changeBaseMap('dark')">üåô Oscuro</div>
            <div class="basemap-option" onclick="changeBaseMap('satellite')">üõ∞Ô∏è Sat√©lite</div>
        </div>
    </div>
    
    <div class="legend">
        <h4>Categor√≠as</h4>
        <div class="legend-item">
            <div class="legend-color" style="background: #2ca25f;"></div>
            <span>Alto (DN=3)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #ffdd33;"></div>
            <span>Medio (DN=4)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #de2d26;"></div>
            <span>Bajo (DN=5)</span>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <script>
        // Inicializa el mapa
        const map = L.map('map', {
            center: [41.5, -4],
            zoom: 7
        });

        // Capas base
        const baseLight = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CartoDB contributors',
            subdomains: 'abcd'
        });

        const baseDark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CartoDB contributors',
            subdomains: 'abcd'
        });

        const baseSatellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri'
        });

        baseLight.addTo(map);

        // Funciones para cambiar mapa base
        function changeBaseMap(style) {
            map.eachLayer(layer => {
                if (layer === baseLight || layer === baseDark || layer === baseSatellite) {
                    map.removeLayer(layer);
                }
            });

            if (style === 'light') baseLight.addTo(map);
            else if (style === 'dark') baseDark.addTo(map);
            else if (style === 'satellite') baseSatellite.addTo(map);
            
            toggleMenu();
        }

        function toggleMenu() {
            const menu = document.getElementById('basemapMenu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        // CARGAR GEOJSON CON L√ìGICA CORREGIDA
        fetch('ZONAS_VALIDAS.geojson')
            .then(response => {
                if (!response.ok) throw new Error('No se pudo cargar el archivo GeoJSON');
                return response.json();
            })
            .then(data => {
                console.log('GeoJSON cargado correctamente');

                const geojsonLayer = L.geoJSON(data, {
                    style: function(feature) {
                        // Detectamos el valor DN independientemente de si es may√∫scula o min√∫scula
                        const props = feature.properties || {};
                        const dn = props.DN !== undefined ? props.DN : props.dn;

                        // Usamos == para comparar por si el valor viene como texto "3" o n√∫mero 3
                        return {
                            fillColor: dn == 3 ? '#2ca25f' : 
                                       dn == 4 ? '#ffdd33' : 
                                       dn == 5 ? '#de2d26' : '#cccccc',
                            weight: 1,
                            color: 'black',
                            fillOpacity: 0.7
                        };
                    },
                    onEachFeature: function(feature, layer) {
                        const props = feature.properties || {};
                        const dn = props.DN !== undefined ? props.DN : props.dn;
                        
                        const categoria = dn == 3 ? 'ALTO' :
                                          dn == 4 ? 'MEDIO' :
                                          dn == 5 ? 'BAJO' : 'DESCONOCIDO';

                        let popupContent = `<div style="font-family: Arial;">`;
                        popupContent += `<strong>Categor√≠a:</strong> ${categoria}<br>`;
                        popupContent += `<strong>Valor DN:</strong> ${dn || 'N/A'}<br>`;
                        
                        // A√±adir √°rea si existe
                        const area = props.Area_km || props.area || props.AREA;
                        if (area) {
                            popupContent += `<strong>√Årea:</strong> ${area} km¬≤<br>`;
                        }

                        // Debug: Muestra todas las propiedades si el popup dice "Desconocido"
                        if (categoria === 'DESCONOCIDO') {
                            popupContent += `<hr><small>Campos detectados:<br>`;
                            for (let key in props) {
                                popupContent += `${key}: ${props[key]}<br>`;
                            }
                            popupContent += `</small>`;
                        }
                        
                        popupContent += `</div>`;
                        layer.bindPopup(popupContent);
                    }
                }).addTo(map);

                // Ajustar vista autom√°ticamente a los datos
                if (geojsonLayer.getBounds().isValid()) {
                    map.fitBounds(geojsonLayer.getBounds());
                }
                
                document.getElementById('loading').style.display = 'none';
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('loading').innerHTML = 
                    'Error al cargar los datos.<br><small>' + error.message + '</small>';
            });

        // Pantalla completa
        document.getElementById('fullscreen-btn').addEventListener('click', () => {
            const mapContainer = document.getElementById('map');
            if (!document.fullscreenElement) {
                if (mapContainer.requestFullscreen) {
                    mapContainer.requestFullscreen();
                }
                document.getElementById('fullscreen-btn').innerHTML = '<i class="fas fa-compress"></i>';
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
                document.getElementById('fullscreen-btn').innerHTML = '<i class="fas fa-expand"></i>';
            }
        });
    </script>
</body>
</html>